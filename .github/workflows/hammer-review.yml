name: Hammer Review (RFD)

on:
  push:
    branches:
      - main
      - "feature/**"

jobs:
  hammer-review:
    if: |
      !contains(github.event.head_commit.message, '[skip-hammer]')
    runs-on: ubuntu-latest
    concurrency:
      group: hammer-review-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install sprite CLI
        env:
          SPRITE_INSTALL_BIN_DIR: ${{ runner.temp }}/sprite-bin
        run: |
          curl -fsSL https://sprites.dev/install.sh | bash
          echo "${SPRITE_INSTALL_BIN_DIR}" >> "$GITHUB_PATH"

      - name: Install Infisical CLI
        run: |
          curl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.deb.sh' | sudo -E bash
          sudo apt-get update
          sudo apt-get install -y infisical

      - name: Load secrets from Infisical
        env:
          INFISICAL_TOKEN: ${{ secrets.INFISICAL_TOKEN }}
          INFISICAL_PROJECT_ID: ${{ secrets.INFISICAL_PROJECT_ID }}
          INFISICAL_ENV: ${{ secrets.INFISICAL_ENV }}
        run: |
          INFISICAL_ENV="${INFISICAL_ENV:-dev}"
          infisical export \
            --token="$INFISICAL_TOKEN" \
            --projectId="$INFISICAL_PROJECT_ID" \
            --env="$INFISICAL_ENV" \
            --format=dotenv > /tmp/infisical.env
          set -a
          source /tmp/infisical.env
          set +a
          echo "SPRITES_API_TOKEN=$SPRITES_API_TOKEN" >> "$GITHUB_ENV"

      - name: Run hammer review
        env:
          SPRITES_API_TOKEN: ${{ env.SPRITES_API_TOKEN }}
        run: |
          BEFORE_SHA="${{ github.event.before }}"
          SHA="${{ github.sha }}"
          SHORT_SHA="${SHA:0:7}"
          DATE_UTC="$(date -u +%Y%m%d)"
          export BEFORE_SHA SHA SHORT_SHA DATE_UTC
          PROMPT_B64="$(python -c "import base64, os; before_sha=os.environ['BEFORE_SHA']; sha=os.environ['SHA']; short_sha=os.environ['SHORT_SHA']; date_utc=os.environ['DATE_UTC']; prompt=(f'You are reviewing commit {sha} in /home/sprite/workspace/rs-1.\\n\\n' f'Task:\\n' f'1) Check out the repo at the commit SHA and inspect the diff from {before_sha}..{sha}.\\n' f'   If BEFORE_SHA is 0000000... (new branch), use \"git show {sha}\".\\n' f'2) Perform an in-depth code review focused on bugs, behavior regressions, risks,\\n' f'   and missing tests. Prioritize critical issues.\\n' f'3) Create a new RFD file at docs/rfd/RFD-{date_utc}-{short_sha}-hammer-review.md with:\\n' f'   - Title: \"RFD: Hammer Review {short_sha}\"\\n' f'   - Commit: {sha}\\n' f'   - Summary\\n' f'   - Findings (ordered by severity)\\n' f'   - Recommended actions\\n' f'4) Commit and push the RFD with message:\\n' f'   \"RFD: hammer review {short_sha} [skip-hammer]\"\\n\\n' f'Constraints:\\n' f'- Keep changes limited to the RFD file.\\n' f'- Do not modify unrelated files.\\n' f'- Use git diff or git show to reference specific files/lines where possible.\\n'); print(base64.b64encode(prompt.encode('utf-8')).decode('utf-8'))")"
          sprite auth setup --token "$SPRITES_API_TOKEN"
          sprite exec -http-post -s hammer /bin/bash -lc "
            set -euo pipefail
            cd /home/sprite/workspace/rs-1
            git fetch origin
            git checkout ${SHA}
            git reset --hard ${SHA}
            mkdir -p docs/rfd
            PROMPT=\"\$(echo ${PROMPT_B64} | base64 -d)\"
            claude --print --output-format json --dangerously-skip-permissions --max-turns 30 \"\${PROMPT}\"
          "
