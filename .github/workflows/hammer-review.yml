name: Hammer Review (RFD)

on:
  push:
    branches:
      - main
      - "feature/**"

jobs:
  hammer-review:
    if: |
      !contains(github.event.head_commit.message, '[skip-hammer]')
    runs-on: ubuntu-latest
    concurrency:
      group: hammer-review-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install sprite CLI
        env:
          SPRITE_INSTALL_BIN_DIR: ${{ runner.temp }}/sprite-bin
        run: |
          curl -fsSL https://sprites.dev/install.sh | bash
          echo "${SPRITE_INSTALL_BIN_DIR}" >> "$GITHUB_PATH"

      - name: Install Infisical CLI
        run: |
          curl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.deb.sh' | sudo -E bash
          sudo apt-get update
          sudo apt-get install -y infisical

      - name: Load secrets from Infisical
        env:
          INFISICAL_TOKEN: ${{ secrets.INFISICAL_TOKEN }}
          INFISICAL_PROJECT_ID: ${{ secrets.INFISICAL_PROJECT_ID }}
          INFISICAL_ENV: ${{ secrets.INFISICAL_ENV }}
        run: |
          INFISICAL_ENV="${INFISICAL_ENV:-dev}"
          infisical export \
            --token="$INFISICAL_TOKEN" \
            --projectId="$INFISICAL_PROJECT_ID" \
            --env="$INFISICAL_ENV" \
            --format=dotenv > /tmp/infisical.env
          set -a
          source /tmp/infisical.env
          set +a
          echo "SPRITES_API_TOKEN=$SPRITES_API_TOKEN" >> "$GITHUB_ENV"

      - name: Run hammer review
        env:
          SPRITES_API_TOKEN: ${{ env.SPRITES_API_TOKEN }}
        run: |
          BEFORE_SHA="${{ github.event.before }}"
          SHA="${{ github.sha }}"
          SHORT_SHA="${SHA:0:7}"
          DATE_UTC="$(date -u +%Y%m%d)"
          PROMPT_B64="$(cat <<EOF | base64 -w 0
You are reviewing commit ${SHA} in /home/sprite/workspace/rs-1.

Task:
1) Check out the repo at the commit SHA and inspect the diff from ${BEFORE_SHA}..${SHA}.
   If BEFORE_SHA is 0000000... (new branch), use "git show ${SHA}".
2) Perform an in-depth code review focused on bugs, behavior regressions, risks,
   and missing tests. Prioritize critical issues.
3) Create a new RFD file at docs/rfd/RFD-${DATE_UTC}-${SHORT_SHA}-hammer-review.md with:
   - Title: "RFD: Hammer Review ${SHORT_SHA}"
   - Commit: ${SHA}
   - Summary
   - Findings (ordered by severity)
   - Recommended actions
4) Commit and push the RFD with message:
   "RFD: hammer review ${SHORT_SHA} [skip-hammer]"

Constraints:
- Keep changes limited to the RFD file.
- Do not modify unrelated files.
- Use git diff or git show to reference specific files/lines where possible.
EOF
)"
          sprite auth setup --token "$SPRITES_API_TOKEN"
          sprite exec -http-post -s hammer /bin/bash -lc "
            set -euo pipefail
            cd /home/sprite/workspace/rs-1
            git fetch origin
            git checkout ${SHA}
            git reset --hard ${SHA}
            mkdir -p docs/rfd
            PROMPT=\"\$(echo ${PROMPT_B64} | base64 -d)\"
            claude --print --output-format json --dangerously-skip-permissions --max-turns 30 \"\${PROMPT}\"
          "
